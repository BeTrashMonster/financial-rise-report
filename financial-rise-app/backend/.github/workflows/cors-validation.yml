name: CORS Configuration Validation

# Work Stream 59 (HIGH-010) - CORS Configuration Hardening
# Purpose: Automated validation of CORS configuration security
# Runs on: PRs, commits to main, and manual trigger

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/main.ts'
      - 'src/config/cors.config.ts'
      - 'src/security/cors-configuration.spec.ts'
      - '.github/workflows/cors-validation.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/main.ts'
      - 'src/config/cors.config.ts'
      - 'src/security/cors-configuration.spec.ts'
  workflow_dispatch: # Allow manual trigger

jobs:
  cors-security-validation:
    name: CORS Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run CORS configuration tests
        run: npm test -- src/security/cors-configuration.spec.ts --coverage --testTimeout=30000
        env:
          NODE_ENV: test
          # Test with multiple origin configurations
          FRONTEND_URL: https://app.financialrise.com
          FRONTEND_URL_STAGING: https://staging.financialrise.com

      - name: Validate CORS configuration
        run: |
          echo "ðŸ” Validating CORS configuration security..."

          # Check that origin whitelist is used (not wildcard)
          if grep -r "origin: '\*'" src/config/cors.config.ts; then
            echo "âŒ ERROR: Wildcard origin (*) detected - SECURITY VIOLATION"
            exit 1
          fi

          # Check that credentials are properly configured
          if ! grep -r "credentials: true" src/config/cors.config.ts; then
            echo "âš ï¸  WARNING: Credentials not enabled"
          fi

          # Check that logging is implemented
          if ! grep -r "logger.warn.*CORS.*Blocked" src/config/cors.config.ts; then
            echo "âŒ ERROR: CORS blocking logging not implemented"
            exit 1
          fi

          # Check that methods are explicitly defined
          if ! grep -r "methods:" src/config/cors.config.ts; then
            echo "âŒ ERROR: HTTP methods not explicitly defined"
            exit 1
          fi

          # Check that headers are explicitly defined
          if ! grep -r "allowedHeaders:" src/config/cors.config.ts; then
            echo "âŒ ERROR: Allowed headers not explicitly defined"
            exit 1
          fi

          echo "âœ… CORS configuration validation passed"

      - name: Check for dangerous HTTP methods
        run: |
          echo "ðŸ” Checking for dangerous HTTP methods..."

          # Ensure TRACE and CONNECT are not allowed
          if grep -r "TRACE\|CONNECT" src/config/cors.config.ts; then
            echo "âŒ ERROR: Dangerous HTTP methods (TRACE/CONNECT) detected"
            exit 1
          fi

          echo "âœ… No dangerous HTTP methods found"

      - name: Validate environment variable usage
        run: |
          echo "ðŸ” Validating environment variable configuration..."

          # Check that FRONTEND_URL is used
          if ! grep -r "FRONTEND_URL" src/config/cors.config.ts; then
            echo "âš ï¸  WARNING: FRONTEND_URL environment variable not used"
          fi

          # Check that hardcoded production URLs are not present
          if grep -r "https://.*\.com" src/config/cors.config.ts | grep -v "filter\|comment"; then
            echo "âš ï¸  WARNING: Hardcoded production URLs detected - use environment variables"
          fi

          echo "âœ… Environment variable validation passed"

      - name: Security edge case validation
        run: |
          echo "ðŸ” Validating security edge cases..."

          # Ensure case-sensitive origin matching
          if grep -i "tolowercase\|touppercase" src/config/cors.config.ts; then
            echo "âš ï¸  WARNING: Case-insensitive origin matching detected - origins should be case-sensitive"
          fi

          # Check that origin callback validates the origin parameter
          if ! grep -r "origin.*callback" src/config/cors.config.ts; then
            echo "âŒ ERROR: Origin validation callback not implemented"
            exit 1
          fi

          echo "âœ… Security edge case validation passed"

      - name: Upload test coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: cors-security
          name: cors-configuration-coverage

      - name: Generate security report
        if: always()
        run: |
          echo "# CORS Configuration Security Report" > cors-security-report.md
          echo "" >> cors-security-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> cors-security-report.md
          echo "**Commit:** ${{ github.sha }}" >> cors-security-report.md
          echo "" >> cors-security-report.md
          echo "## Configuration Status" >> cors-security-report.md
          echo "" >> cors-security-report.md
          echo "- âœ… Origin whitelist validation" >> cors-security-report.md
          echo "- âœ… Credentials configuration" >> cors-security-report.md
          echo "- âœ… Explicit methods configuration" >> cors-security-report.md
          echo "- âœ… Explicit headers configuration" >> cors-security-report.md
          echo "- âœ… Security logging implemented" >> cors-security-report.md
          echo "- âœ… No dangerous HTTP methods" >> cors-security-report.md
          echo "" >> cors-security-report.md
          echo "## Test Results" >> cors-security-report.md
          echo "" >> cors-security-report.md
          echo "See test output above for detailed results." >> cors-security-report.md

      - name: Comment PR with security report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('cors-security-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  cors-penetration-testing:
    name: CORS Penetration Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: cors-security-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start application
        run: |
          npm run build
          npm run start:prod &
          echo $! > app.pid

          # Wait for application to start
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/v1/health 2>/dev/null; then
              echo "âœ… Application started"
              break
            fi
            echo "Waiting for application to start... ($i/30)"
            sleep 2
          done
        env:
          NODE_ENV: production
          JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET_TEST }}
          DB_ENCRYPTION_KEY: ${{ secrets.DB_ENCRYPTION_KEY_TEST }}

      - name: Test whitelisted origin
        run: |
          echo "ðŸ§ª Testing whitelisted origin..."

          RESPONSE=$(curl -X OPTIONS http://localhost:3000/api/v1/auth/login \
            -H "Origin: http://localhost:3001" \
            -H "Access-Control-Request-Method: POST" \
            -i -s)

          if echo "$RESPONSE" | grep -q "Access-Control-Allow-Origin: http://localhost:3001"; then
            echo "âœ… Whitelisted origin allowed"
          else
            echo "âŒ Whitelisted origin blocked - FAIL"
            exit 1
          fi

      - name: Test unauthorized origin
        run: |
          echo "ðŸ§ª Testing unauthorized origin..."

          RESPONSE=$(curl -X OPTIONS http://localhost:3000/api/v1/auth/login \
            -H "Origin: http://evil.com" \
            -H "Access-Control-Request-Method: POST" \
            -i -s)

          if echo "$RESPONSE" | grep -q "Access-Control-Allow-Origin:"; then
            echo "âŒ Unauthorized origin allowed - SECURITY VIOLATION"
            exit 1
          else
            echo "âœ… Unauthorized origin blocked"
          fi

      - name: Test CORS with credentials
        run: |
          echo "ðŸ§ª Testing credentials configuration..."

          RESPONSE=$(curl -X OPTIONS http://localhost:3000/api/v1/auth/login \
            -H "Origin: http://localhost:3001" \
            -H "Access-Control-Request-Method: POST" \
            -i -s)

          if echo "$RESPONSE" | grep -q "Access-Control-Allow-Credentials: true"; then
            echo "âœ… Credentials enabled"
          else
            echo "âš ï¸  WARNING: Credentials not enabled"
          fi

      - name: Test dangerous methods blocked
        run: |
          echo "ðŸ§ª Testing dangerous method blocking..."

          RESPONSE=$(curl -X OPTIONS http://localhost:3000/api/v1/auth/login \
            -H "Origin: http://localhost:3001" \
            -H "Access-Control-Request-Method: TRACE" \
            -i -s)

          ALLOWED_METHODS=$(echo "$RESPONSE" | grep -i "Access-Control-Allow-Methods" || echo "")

          if echo "$ALLOWED_METHODS" | grep -q "TRACE"; then
            echo "âŒ Dangerous method TRACE allowed - SECURITY VIOLATION"
            exit 1
          else
            echo "âœ… Dangerous methods blocked"
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
          fi

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [cors-security-validation, cors-penetration-testing]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# CORS Configuration Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Work Stream:** 59 (HIGH-010)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** All security validations passed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Validations Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Origin whitelist validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Credentials configuration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTP methods validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Headers configuration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security logging" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Penetration testing" >> $GITHUB_STEP_SUMMARY
